<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mes petites choses √† faire</title>
  <style>
    :root { --green:#2ecc71; --dark:#145a32; }
    body { font-family: Arial, sans-serif; margin:0 auto; max-width:900px; padding:24px; }
    h1 { color: var(--green); text-shadow: 0 3px 0 var(--dark); margin:16px 0 8px; text-align:center }
    h2 { color:#6ee7b7; text-shadow:0 2px 0 #065f46; text-align:center; margin:24px 0 8px }
    .hidden { display:none }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin:12px auto; max-width:520px }
    input, button { padding:10px 12px; border-radius:8px; border:1px solid #d1d5db; }
    button { cursor:pointer; border-color:#10b981; color:#065f46; background:#ecfdf5; }
    ul { list-style:disc; padding-left:24px }
    li.done { text-decoration: line-through; opacity:.65 }
    .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap }
    .muted { color:#6b7280; text-align:center }
  </style>
</head>
<body>
  <h1>Mes petites choses √† faire</h1>
  <p id="slogan" class="muted">Chaque jour, je prends le contr√¥le et je d√©passe mes limites</p>

  <!-- SECTION AUTH -->
  <section id="auth" class="card">
    <h2>Se connecter / S'inscrire</h2>
    <div class="row">
      <input id="email" type="email" placeholder="Email" required />
      <input id="password" type="password" placeholder="Mot de passe" required />
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btn-login">Se connecter</button>
      <button id="btn-signup">Cr√©er un compte</button>
    </div>
    <p class="muted" id="auth-msg"></p>
  </section>

  <!-- SECTION APP -->
  <section id="app" class="hidden">
    <h2 id="welcome"></h2>

    <div class="card">
      <div class="row">
        <input id="tache-input" type="text" placeholder="√âcris ta t√¢che ici" />
        <button id="btn-add">Ajouter</button>
      </div>
    </div>

    <ul id="liste-taches" class="card"></ul>

    <div class="row">
      <button id="btn-logout">Se d√©connecter</button>
    </div>
  </section>

  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // 1) CONFIG ‚Äî> remplace ces deux valeurs depuis ton tableau de bord Supabase
    const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOi...REMPLACE_MOI...";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helpers UI
    const el = (id) => document.getElementById(id);
    const show = (id, v) => el(id).classList.toggle('hidden', !v);

    // 2) √âtat de session au chargement
    init();
    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) { onLogin(session); }
      else { onLogout(); }
      // √©couter les changements (login/logout)
      supabase.auth.onAuthStateChange((_event, sess) => {
        if (sess) onLogin(sess); else onLogout();
      });
    }

    // 3) AUTH ‚Äî login / signup / logout
    el("btn-login").onclick = async () => {
      setAuthMsg("Connexion‚Ä¶");
      const { data, error } = await supabase.auth.signInWithPassword({
        email: el("email").value.trim(),
        password: el("password").value
      });
      if (error) setAuthMsg(error.message);
      else setAuthMsg("Connect√© !");
    };

    el("btn-signup").onclick = async () => {
      setAuthMsg("Cr√©ation du compte‚Ä¶");
      const { data, error } = await supabase.auth.signUp({
        email:el("email").value.trim(),
        password: el("password").value
      });
      if (error) setAuthMsg(error.message);
      else setAuthMsg("Compte cr√©√©. V√©rifie ton pseudo, puis connecte-toi.");
    };

    el("btn-logout").onclick = async () => { await supabase.auth.signOut(); };

    function setAuthMsg(msg){ el("auth-msg").textContent = msg; }

    // 4) Quand connect√© ‚Üí charger l'app
    async function onLogin(session){
      show("auth", false);
      show("app", true);
      el("welcome").textContent = "Bienvenue " + (session.user.email|| "üëã");

      // charger les t√¢ches
      await loadTasks();

      // actions
      el("btn-add").onclick = addTask;
    }

    function onLogout(){
      show("app", false);
      show("auth", true);
      el("liste-taches").innerHTML = "";
      setAuthMsg("");
    }

    // 5) CRUD T√¢ches (s√©curis√© par RLS c√¥t√© serveur)
    async function loadTasks(){
      const { data, error } = await supabase
        .from("tasks")
        .select("*")
        .order("created_at", { ascending: false });
      if (error) { alert(error.message); return; }
      renderTasks(data || []);
    }

    async function addTask(){
      const text = el("tache-input").value.trim();
      if (!text) return;
      const { data: { user } } = await supabase.auth.getUser();
      const { error } = await supabase.from("tasks").insert({
        user_id: user.id, text
      });
      if (error) { alert(error.message); return; }
      el("tache-input").value = "";
      await loadTasks();
    }

    async function toggleDone(id, current){
      const { error } = await supabase
        .from("tasks")
        .update({ done: !current })
        .eq("id", id);
      if (error) { alert(error.message); return; }
      await loadTasks();
    }

    async function removeTask(id){
      const { error } = await supabase.from("tasks").delete().eq("id", id);
      if (error) { alert(error.message); return; }
      await loadTasks();
    }

    function renderTasks(tasks){
      const ul = el("liste-taches");
      ul.innerHTML = "";
      if (!tasks.length) { ul.innerHTML = "<li class='muted'>Aucune t√¢che pour le moment.</li>"; return; }

      tasks.forEach(t => {
        const li = document.createElement("li");
        li.className = t.done ? "done" : "";
        li.innerHTML = `
          <strong>${escapeHtml(t.text)}</strong>
          <div class="row" style="margin-top:6px">
            <button data-id="${t.id}" data-done="${t.done}" class="btn-toggle">Marquer ${t.done ? "√† faire" : "faite"}</button>
            <button data-id="${t.id}" class="btn-del">Supprimer</button>
          </div>
        `;
        ul.appendChild(li);
      });

      // d√©l√©gation d'√©v√©nements
      ul.querySelectorAll(".btn-toggle").forEach(b=>{
        b.onclick = () => toggleDone(b.dataset.id, b.dataset.done === "true");
      });
      ul.querySelectorAll(".btn-del").forEach(b=>{
        b.onclick = () => removeTask(b.dataset.id);
      });
    }

    // petit helper pour √©viter l‚Äôinjection HTML dans les t√¢ches
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }
  </script>
</body>
        </html>
